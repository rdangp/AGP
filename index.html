<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MicroChallenges — 24h Skill Challenges</title>
  <style>
    :root{--bg:#0f172a;--card:#0f172a;--muted:#94a3b8;--accent:#7c3aed;--glass:rgba(255,255,255,0.04)}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,ui-sans-serif,system-ui,Arial;background:linear-gradient(180deg,#071028,#071828);color:#e6eef6}
    .wrap{max-width:1100px;margin:28px auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    h1{margin:0;font-size:20px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:52px;height:52px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#06b6d4);display:flex;align-items:center;justify-content:center;font-weight:700}
    .main{display:grid;grid-template-columns:1fr 360px;gap:18px;margin-top:18px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    form label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type=text], select, textarea, input[type=number], input[type=datetime-local]{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
    textarea{min-height:80px}
    .btn{background:var(--accent);border:0;padding:10px 12px;border-radius:10px;color:white;cursor:pointer;font-weight:600}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}

    .list{display:flex;flex-direction:column;gap:12px}
    .challenge{display:flex;flex-direction:column;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00))}
    .meta{font-size:13px;color:var(--muted);display:flex;gap:8px;align-items:center}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .small{font-size:13px;color:var(--muted)}
    .accept-list{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}
    .pill{padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.03);font-size:13px}

    .sidebar .profile{display:flex;gap:12px;align-items:center}
    .avatar{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,#34d399,#06b6d4);display:flex;align-items:center;justify-content:center;font-weight:700}
    .category-list{display:flex;flex-direction:column;gap:8px;margin-top:12px}
    .category-item{display:flex;justify-content:space-between}

    .submission{display:flex;gap:8px;align-items:center}
    video, img{max-width:220px;border-radius:8px}
    .vote-btn{padding:6px 8px;border-radius:8px;border:0;background:#0b1220;color:#fff;cursor:pointer}

    .muted{color:var(--muted)}
    @media (max-width:980px){.main{grid-template-columns:1fr} .sidebar{order:2}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">MC</div>
        <div>
          <h1>MicroChallenges</h1>
          <div class="small muted">Create, accept, and share 24-hour micro-challenges</div>
        </div>
      </div>
      <div>
        <button id="btnSeed" class="btn ghost">Seed demo data</button>
        <button id="btnClear" class="btn ghost">Clear all</button>
      </div>
    </header>

    <div class="main">
      <div>
        <div class="card">
          <h3>Create a new 24h Challenge</h3>
          <form id="formCreate">
            <label>Title</label>
            <input id="title" type="text" required placeholder="E.g. 5-minute latte art" />

            <label>Category</label>
            <select id="category">
              <option>Cooking</option>
              <option>Coding</option>
              <option>Art</option>
              <option>Fitness</option>
              <option>Language</option>
              <option>Music</option>
              <option>Other</option>
            </select>

            <label>Short description</label>
            <textarea id="desc" placeholder="Explain the task and success criteria"></textarea>

            <label>Difficulty / Points (1-100)</label>
            <input id="points" type="number" min="1" max="100" value="30" />

            <label>Deadline (must be within 24 hours from now)</label>
            <input id="deadline" type="datetime-local" />

            <div style="margin-top:10px;display:flex;gap:8px">
              <button class="btn" type="submit">Create Challenge</button>
              <button id="btnDemoCreate" type="button" class="btn ghost">Quick demo</button>
            </div>
          </form>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>Active Challenges</h3>
          <div id="challenges" class="list"></div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>All Submissions</h3>
          <div id="submissions" class="list"></div>
        </div>
      </div>

      <aside class="sidebar">
        <div class="card profile">
          <div class="avatar" id="avatar">U</div>
          <div>
            <div id="username" style="font-weight:700">You (guest)</div>
            <div class="small muted">Local profile — points are stored in your browser</div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h4>Your Skill Points</h4>
          <div id="skillPoints" class="category-list"></div>
        </div>

        <div class="card" style="margin-top:12px">
          <h4>How scoring works</h4>
          <div class="small muted">Community members vote on each submission using three criteria: creativity, speed, and style. After the challenge ends, top submissions earn category points that appear on public profiles.</div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Modals will be created dynamically -->

  <script>
    /*******************************************************************
     * MicroChallenges — single-file demo app
     * - Uses localStorage to persist data (no backend).
     * - Enforces 24-hour max deadline at creation time.
     * - Users are simulated by a local random ID stored in localStorage.
     * - Submissions accept photo or short video (stored as dataURL).
     * - Voting limited to one vote per user per submission, tracked locally.
     * - Simple scoring & awarding system implemented client-side.
     *******************************************************************/

    // Utilities & storage keys
    const LS = {CH:'mc_challenges_v1', SUB:'mc_submissions_v1', USERS:'mc_users_v1', ME:'mc_me_v1'};

    function uid(len=8){return Math.random().toString(36).slice(2,2+len)}
    function nowISO(){return new Date().toISOString()}

    // Ensure a local user exists
    let me = JSON.parse(localStorage.getItem(LS.ME) || 'null');
    if(!me){ me = {id: uid(6), name: 'Guest-'+Math.floor(Math.random()*900+100), points:{}}; localStorage.setItem(LS.ME, JSON.stringify(me)); }
    document.getElementById('username').textContent = me.name; document.getElementById('avatar').textContent = me.name[0] || 'U';

    // Load / save
    function load(key){return JSON.parse(localStorage.getItem(key) || '[]');}
    function save(key, data){localStorage.setItem(key, JSON.stringify(data));}

    // Initialize empty stores if missing
    if(!localStorage.getItem(LS.CH)) save(LS.CH, []);
    if(!localStorage.getItem(LS.SUB)) save(LS.SUB, []);

    // DOM refs
    const form = document.getElementById('formCreate');
    const challengesEl = document.getElementById('challenges');
    const submissionsEl = document.getElementById('submissions');
    const skillPointsEl = document.getElementById('skillPoints');
    const btnSeed = document.getElementById('btnSeed');
    const btnClear = document.getElementById('btnClear');
    const btnDemoCreate = document.getElementById('btnDemoCreate');

    // Helpers
    function within24h(dt){
      const selected = new Date(dt);
      const diff = selected - Date.now();
      return diff>0 && diff <= 24*3600*1000;
    }

    // Create challenge handler
    form.addEventListener('submit', (e)=>{
      e.preventDefault();
      const title = document.getElementById('title').value.trim();
      const category = document.getElementById('category').value;
      const desc = document.getElementById('desc').value.trim();
      const points = Math.max(1, Math.min(100, Number(document.getElementById('points').value || 30)));
      const deadlineVal = document.getElementById('deadline').value;
      if(!title){alert('Please add a title'); return}
      if(!deadlineVal || !within24h(deadlineVal)){alert('Deadline must be set and within the next 24 hours'); return}

      const chs = load(LS.CH);
      const id = 'ch_'+uid(6);
      chs.unshift({id,title,category,desc,points,creator:me.id, createdAt:nowISO(), deadline:new Date(deadlineVal).toISOString(), participants:[], finalized:false});
      save(LS.CH, chs);
      form.reset(); render();
    });

    btnDemoCreate.addEventListener('click', ()=>{
      const d = new Date(Date.now()+6*3600*1000);
      document.getElementById('title').value = '30-min Speed Sketch';
      document.getElementById('desc').value = 'Draw a portrait in under 30 minutes — show before/after or time-lapse.';
      document.getElementById('points').value = '40';
      document.getElementById('deadline').value = d.toISOString().slice(0,16);
    });

    // Accept challenge (join)
    function acceptChallenge(chId){
      const chs = load(LS.CH);
      const ch = chs.find(c=>c.id===chId); if(!ch) return;
      if(ch.participants.includes(me.id)) { alert('You already accepted'); return }
      ch.participants.push(me.id); save(LS.CH, chs); render();
    }

    // Open submission modal
    function openSubmissionModal(chId){
      const modal = document.createElement('div');
      modal.style.position='fixed'; modal.style.inset=0; modal.style.display='flex'; modal.style.alignItems='center'; modal.style.justifyContent='center'; modal.style.background='rgba(2,6,23,0.6)'; modal.style.zIndex=9999;
      modal.innerHTML = `
        <div style="width:680px;max-width:96%;background:linear-gradient(180deg, #061226, #071829);padding:14px;border-radius:12px">
          <h3 style="margin-top:0">Submit Proof</h3>
          <div id="modalInfo" class="small muted"></div>
          <div style="margin-top:8px">
            <label class="small muted">Add a short photo or video (max ~30MB)</label>
            <input id="fileProof" type="file" accept="image/*,video/*" />
          </div>
          <div style="margin-top:10px;display:flex;gap:8px">
            <button id="submitProofBtn" class="btn">Submit</button>
            <button id="cancelProofBtn" class="btn ghost">Cancel</button>
          </div>
          <div id="previewArea" style="margin-top:10px"></div>
        </div>
      `;
      document.body.appendChild(modal);

      const fileInput = modal.querySelector('#fileProof');
      const preview = modal.querySelector('#previewArea');
      const info = modal.querySelector('#modalInfo');
      info.textContent = 'Challenge ID: ' + chId;

      fileInput.addEventListener('change', ()=>{
        preview.innerHTML='';
        const f = fileInput.files[0];
        if(!f) return;
        if(f.size > 32*1024*1024){ alert('File too big (max 32MB)'); fileInput.value=''; return }
        const reader = new FileReader();
        reader.onload = ()=>{
          const url = reader.result;
          if(f.type.startsWith('video/')){ preview.innerHTML = `<video controls src="${url}"></video>` }
          else { preview.innerHTML = `<img src="${url}" />` }
        };
        reader.readAsDataURL(f);
      });

      modal.querySelector('#cancelProofBtn').addEventListener('click', ()=> modal.remove());

      modal.querySelector('#submitProofBtn').addEventListener('click', ()=>{
        const f = fileInput.files[0]; if(!f){ alert('Choose a file first'); return }
        const reader = new FileReader();
        reader.onload = ()=>{
          const subs = load(LS.SUB);
          const id = 's_'+uid(6);
          subs.unshift({id, challengeId:chId, author:me.id, fileData:reader.result, fileType:f.type, createdAt:nowISO(), votes:{creativity:{},speed:{},style:{}}, score:0});
          save(LS.SUB, subs);
          modal.remove(); render();
        };
        reader.readAsDataURL(f);
      });
    }

    // Voting
    function vote(subId, criterion){
      const subs = load(LS.SUB);
      const sub = subs.find(s=>s.id===subId); if(!sub) return;
      // prevent same user voting twice on same criterion
      if(sub.votes[criterion][me.id]){ alert('You already voted on this criterion for this submission'); return }
      sub.votes[criterion][me.id] = 1; // simple +1 vote
      // recompute score: weights: creativity=3, speed=2, style=2
      const c = Object.keys(sub.votes.creativity).length;
      const sp = Object.keys(sub.votes.speed).length;
      const st = Object.keys(sub.votes.style).length;
      sub.score = c*3 + sp*2 + st*2;
      save(LS.SUB, subs); render();
    }

    // Finalize challenge (determine winners and award points) — manual trigger
    function finalizeChallenge(chId){
      const chs = load(LS.CH); const subs = load(LS.SUB);
      const ch = chs.find(c=>c.id===chId); if(!ch) return;
      if(ch.finalized){ alert('Already finalized'); return }
      const related = subs.filter(s=>s.challengeId===chId);
      if(related.length===0){ alert('No submissions yet'); return }
      // sort by score descending
      related.sort((a,b)=>b.score - a.score);
      const winner = related[0];
      // award points: winner gets challenge.points, 2nd gets half, 3rd gets quarter
      const award = (sub)=>{
        const users = JSON.parse(localStorage.getItem(LS.USERS) || '{}');
        const uid = sub.author;
        users[uid] = users[uid] || {id:uid, name: (uid===me.id?me.name:'User-'+uid.slice(-3)), points:{}};
        users[uid].points[ch.category] = (users[uid].points[ch.category] || 0) + (sub===winner? ch.points : (related.indexOf(sub)===1? Math.floor(ch.points/2) : (related.indexOf(sub)===2? Math.floor(ch.points/4) : 0)));
        localStorage.setItem(LS.USERS, JSON.stringify(users));
      };
      related.forEach(award);
      ch.finalized = true; save(LS.CH, chs);
      alert('Challenge finalized. Winner: ' + (winner? winner.author : '—'));
      render();
    }

    // Render functions
    function render(){
      // Challenges
      const chs = load(LS.CH).sort((a,b)=> new Date(b.createdAt)-new Date(a.createdAt));
      challengesEl.innerHTML='';
      chs.forEach(ch=>{
        const el = document.createElement('div'); el.className='challenge';
        const timeLeft = new Date(ch.deadline) - Date.now();
        const ended = timeLeft<=0;
        el.innerHTML = `
          <div class="row"><div>
            <strong>${escapeHtml(ch.title)}</strong>
            <div class="meta">${ch.category} • ${ch.points} pts • created ${new Date(ch.createdAt).toLocaleString()}</div>
          </div>
          <div class="small">${ended?'<span style="color:#fb7185">Ended</span>':'<span class="muted">Ends in '+msToTime(timeLeft)+'</span>'}</div></div>
          <div style="margin-top:8px" class="small muted">${escapeHtml(ch.desc)}</div>
          <div class="accept-list" style="margin-top:8px">
            <div class="pill">Participants: ${ch.participants.length}</div>
            ${ch.finalized?'<div class="pill">Finalized</div>':''}
          </div>
          <div style="margin-top:10px;display:flex;gap:8px">
            <button class="btn" onclick="openSubmissionModal('${ch.id}')">Submit proof</button>
            <button class="btn ghost" onclick="acceptChallenge('${ch.id}')">Accept</button>
            <button class="btn ghost" onclick="finalizeChallenge('${ch.id}')">Finalize</button>
          </div>
        `;
        challengesEl.appendChild(el);
      });

      // Submissions list
      const subs = load(LS.SUB);
      submissionsEl.innerHTML='';
      subs.forEach(s=>{
        const el = document.createElement('div'); el.className='challenge';
        const c = getChallengeById(s.challengeId);
        const authorName = getUserName(s.author);
        let mediaHtml = '';
        if(s.fileType && s.fileType.startsWith('video/')) mediaHtml = `<video controls src="${s.fileData}"></video>`;
        else mediaHtml = `<img src="${s.fileData}" />`;
        el.innerHTML = `
          <div class="row"><div>
            <strong>${escapeHtml(c?c.title:'(challenge removed)')}</strong>
            <div class="meta">by ${authorName} • score ${s.score}</div>
          </div>
          <div class="small muted">${new Date(s.createdAt).toLocaleString()}</div></div>
          <div style="margin-top:8px;display:flex;gap:12px;align-items:flex-start">
            <div>${mediaHtml}</div>
            <div style="flex:1">
              <div class="small muted">Vote for this submission</div>
              <div style="margin-top:8px;display:flex;gap:8px">
                <button class="vote-btn" onclick="vote('${s.id}','creativity')">Creativity (${Object.keys(s.votes.creativity).length})</button>
                <button class="vote-btn" onclick="vote('${s.id}','speed')">Speed (${Object.keys(s.votes.speed).length})</button>
                <button class="vote-btn" onclick="vote('${s.id}','style')">Style (${Object.keys(s.votes.style).length})</button>
              </div>
            </div>
          </div>
        `;
        submissionsEl.appendChild(el);
      });

      // Skill points (public)
      const users = JSON.parse(localStorage.getItem(LS.USERS) || '{}');
      // ensure me is present
      users[me.id] = users[me.id] || {id:me.id, name:me.name, points: me.points || {}};
      skillPointsEl.innerHTML='';
      const myPoints = users[me.id].points || {};
      const keys = Object.keys(myPoints);
      if(keys.length===0) skillPointsEl.innerHTML = '<div class="muted">No points yet — submit and win challenges to earn points!</div>';
      else keys.forEach(k=>{
        const div = document.createElement('div'); div.className='category-item'; div.innerHTML = `<div>${k}</div><div>${myPoints[k]} pts</div>`; skillPointsEl.appendChild(div);
      });
    }

    // Helpers used in render
    function getChallengeById(id){ return load(LS.CH).find(c=>c.id===id); }
    function getUserName(id){ if(id===me.id) return me.name; const users = JSON.parse(localStorage.getItem(LS.USERS) || '{}'); return (users[id] && users[id].name) || ('User-'+id.slice(-4)); }
    function msToTime(ms){ if(ms<=0) return '0s'; const s = Math.floor(ms/1000); const h=Math.floor(s/3600); const m=Math.floor((s%3600)/60); const sec=s%60; return (h? h+'h ':'') + (m? m+'m ':'') + sec+'s'; }
    function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // Seed demo data
    btnSeed.addEventListener('click', ()=>{
      const chs = [
        {id:'ch_demo1', title:'60s Coffee Pour Art', category:'Cooking', desc:'Create a coffee pour art in 60 seconds. Show start and finish.', points:30, creator:me.id, createdAt:nowISO(), deadline:new Date(Date.now()+5*3600*1000).toISOString(), participants:[], finalized:false},
        {id:'ch_demo2', title:'Solve FizzBuzz in 10 minutes', category:'Coding', desc:'Record your screen solving FizzBuzz in under 10 minutes.', points:40, creator:me.id, createdAt:nowISO(), deadline:new Date(Date.now()+8*3600*1000).toISOString(), participants:[], finalized:false}
      ];
      save(LS.CH, chs);
      save(LS.SUB, []);
      localStorage.setItem(LS.USERS, JSON.stringify({}));
      render();
      alert('Demo challenges seeded');
    });

    btnClear.addEventListener('click', ()=>{ if(!confirm('Clear all data stored locally?')) return; localStorage.removeItem(LS.CH); localStorage.removeItem(LS.SUB); localStorage.removeItem(LS.USERS); save(LS.CH, []); save(LS.SUB, []); render(); });

    // Expose some functions globally so buttons in HTML can call them
    window.openSubmissionModal = openSubmissionModal;
    window.acceptChallenge = acceptChallenge;
    window.vote = vote;
    window.finalizeChallenge = finalizeChallenge;

    // Initial render
    render();

  </script>
</body>
</html>
